<!doctype html>
<html lang="en">
   <head>
      <meta charset="utf-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
      <meta name="description" content="" />
      <meta name="author" content="" />
      <title>Shop Item</title>
      <!-- Favicon-->
      <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
      <!-- Bootstrap icons-->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
      <!-- Core theme CSS (includes Bootstrap)-->
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
      <style>
         .delete-review {
           float: right;
         }
       </style>
   </head>
   {{- template "header.html" .}}
   <body>
      <!-- Navigation-->
      <!-- Product section-->
      <section class="py-5">
         <div class="container px-4 px-lg-5 my-5">
            <div class="row gx-4 gx-lg-5 align-items-center">
               <div class="col-md-6"><img class="card-img-top mb-5 mb-md-0" src="{{.Product.ImageURL}}" alt="..." /></div>
               <div class="col-md-6">
                  <h1 class="display-5 fw-bolder">{{.Product.Title}}</h1>
                  <div class="fs-5 mb-5">
                     <span class="text-decoration-line-through">{{.Product.Price}} руб.</span>
                     <span>New price</span>
                  </div>
                  <p class="lead">{{.Product.Description}}</p>
                  <div class="pt-5">
                     {{if (.Session.IsPurchased .Product.ID)}}
                     <h5 class="fw-light">Added to basket!</h5>
                     {{else}}
                     <span data-id="{{.Product.ID}}" class="add-to-basket btn btn-outline-dark w-100">To basket</span>
                     {{end}}
                  </div>
               </div>
            </div>
         </div>
      </section>
      <section class="py-5">
         <div class="container px-4 px-lg-5 my-5">
            <h2 class="fw-bolder mb-4">Reviews</h2>
            <div class="list-group">
               {{$SessionID := .Session.UserID}}
               {{range .Reviews}}
               <a id="review_{{.ID}}" class="list-group-item">
                  {{if eq .UserID $SessionID}}
                  <button type="button" data-id="{{.ID}}" class="btn update-review btn-outline-dark" disabled>Update (in development)</button>
                  <button type="button" data-id="{{.ID}}" class="btn delete-review btn-outline-dark">Delete</button>
                  {{end}}
                  <div class="d-flex w-100 justify-content-between">
                     <h5 class="text-black">Review {{.ID}}</h5>
                     <small class="text-muted">{{.CreationDate}}</small>
                  </div>
                  <p class="text-black">{{.Text}}</p>
                  <small class="text-muted">{{.Username}}</small>
               </a>
               {{end}}
               {{if not .Reviews}} No reviews. Be the first one to create a review!{{end}}
                  <form id="reviewForm" method="POST" action="/products/{{.Product.ID}}/reviews/new">
                     <div class="form-group">
                        <label for="review_text" class="col-sm-2 col-form-label">Review</label>
                        <div class="col-sm-10">
                           <textarea class="form-control border-0 shadow-none" name="review_text" id="review_text" rows="12" placeholder="Enter Your Review" required></textarea>
                        </div>
                     </div>
                     <button type="submit" class="btn btn-outline-dark w-100 mt-3">Create Review</button>
                  </form>
            </div>
         </div>
      </section>
      <!-- Related items section-->
      <section class="py-5 bg-light">
         <div class="container px-4 px-lg-5 mt-5">
            <h2 class="fw-bolder mb-4">You may be interested</h2>
            <div class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
               {{$PrID := .Product.ID}}
               {{range .Related}}
               {{if not (eq $PrID .ID)}}
               <div class="col mb-5">
                  <div class="card h-100">
                     <!-- Sale badge-->
                     <div class="badge bg-dark text-white position-absolute" style="top: 0.5rem; right: 0.5rem">{{.Tag}}</div>
                     <!-- Product image-->
                     <img class="card-img-top" src="{{.ImageURL}}" alt="..." />
                     <!-- Product details-->
                     <div class="card-body p-4">
                        <div class="text-center">
                           <!-- Product name-->
                           <h5 class="fw-bolder">{{.Title}}</h5>
                           <!-- Product reviews-->
                           <div class="d-flex justify-content-center small text-warning mb-2">
                              <div class="bi-star-fill"></div>
                              <div class="bi-star-fill"></div>
                              <div class="bi-star-fill"></div>
                              <div class="bi-star-fill"></div>
                              <div class="bi-star-fill"></div>
                           </div>
                           <!-- Product price-->
                           <!-- <span class="text-muted text-decoration-line-through">$20.00</span> -->
                           {{.Price}} rub.
                        </div>
                     </div>
                     <!-- Product actions-->
                     <div class="card-footer p-4 pt-0 border-top-0 bg-transparent">
                        <div class="text-center"><a class="btn btn-outline-dark mt-auto" href="#">Add to cart</a></div>
                     </div>
                  </div>
               </div>
               {{end}}
               {{end}}
            </div>
         </div>
         </div>
      </section>
      <!-- Footer-->
      <footer class="py-5 bg-dark">
         <div class="container">
            <p class="m-0 text-center text-white">Copyright &copy; Placeholder Inc. 2023</p>
         </div>
      </footer>
      <!-- Core theme JS-->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
      <script src="https://code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
      <script type="text/javascript">
         $('.add-to-basket').click(function() {
           $elem = $(this)
           $.ajax({
             url: '/basket/' + $elem.data("id"),
             type: 'GET',
             data: {},
             success: function(resp) {
               if(resp.updated) {
                   $elem.hide()
                   $elem.parent().prepend(`<div class="text-center"><h5 class="fw-light">Добавлено в корзину!</h5></div>`)
               }
             },
           });
         })
      </script>
      <script type="text/javascript">
         var frm = $('#reviewForm');
         frm.submit(function(e) {
           e.preventDefault();
           $elem = $(this)
           $.ajax({
             url: frm.attr('action'),
             type: frm.attr('method'),
             data: frm.serialize(),
             success: function(resp) {
                var id = resp['id'];
                var creationDate = resp['creation_date'];
                var text = resp['review_text']
                var username = resp['username']
                var reviewItem = createReviewItem(id,creationDate, text, username);
                reviewItem.prepend()
                $elem.hide()
                $elem.parent().append(reviewItem)
             },
           });
         })
      </script>
      <script type="text/javascript">
         $(document).on('click', '.update-review-form', function() {
           $elem = $(this)
           $.ajax({
             url: '/products/' + $elem.data("id") + '/reviews/update',
             type: 'POST',
             data: {},
             success: function(resp) {
                var id = resp['id'];
                var creationDate = resp['creation_date'];
                var text = resp['review_text']
                var username = resp['username']
                var reviewItem = createReviewItem(id,creationDate, text, username);
                $elem.hide()
                $elem.parent().append(reviewItem)
             },
           });
         });
      </script>
      <script type="text/javascript">
         $(document).on('click', '.update-review', function() {
           $elem = $(this)
           $.ajax({
             url: '/products/' + $elem.data("id") + '/reviews/update',
             type: 'POST',
             data: {},
             success: function(resp) {
                var id = resp['id'];
                var creationDate = resp['creation_date'];
                var text = resp['review_text']
                var username = resp['username']
                var reviewItem = createReviewItem(id,creationDate, text, username);
                $elem.hide()
                $elem.parent().append(reviewItem)
             },
           });
         });
      </script>
      <script type="text/javascript">
         $(document).on('click', '.delete-review', function() {
           $elem = $(this);
           $.ajax({
             url: '/products/' + $elem.data("id") + '/reviews/delete',
             type: 'DELETE',
             data: {},
             success: function(resp) {
               if (resp.updated) {
                 $elem.parent().remove();
               }
             },
           });
         }); 
      </script>
      <script type="text/javascript">
         function createReviewItem(ID, creationDate, text, username) {
            // Create the necessary elements
            const anchor = document.createElement('a');
            anchor.className = 'list-group-item';
            anchor.id = 'review_' + ID;
         
            const div = document.createElement('div');
            div.className = 'd-flex w-100 justify-content-between';
         
            const heading = document.createElement('h5');
            heading.className = 'mb-1';
            heading.textContent = 'Review ' + ID;
         
            const smallDate = document.createElement('small');
            smallDate.className = 'text-muted';
            smallDate.textContent = creationDate;
         
            const paragraph = document.createElement('p');
            paragraph.className = 'text-black';
            paragraph.textContent = text;
         
            const smallUsername = document.createElement('small');
            smallUsername.className = 'text-muted';
            smallUsername.textContent = username;

            const deleteButton = document.createElement('button');
            deleteButton.type = 'button';
            deleteButton.setAttribute('data-id', ID);
            deleteButton.className = 'btn delete-review btn-outline-dark';
            deleteButton.textContent = "Delete";

            const updateButton = document.createElement('button');
            updateButton.type = 'button';
            updateButton.setAttribute('data-id', ID);
            updateButton.className = 'btn update-review btn-outline-dark';
            updateButton.textContent= 'Update (in development)';
            updateButton.disabled = true
         
            // Append the elements to build the structure
            div.appendChild(heading);
            div.appendChild(smallDate);
            
            anchor.appendChild(updateButton);
            anchor.appendChild(deleteButton);
            anchor.appendChild(div);
            anchor.appendChild(paragraph);
            anchor.appendChild(smallUsername);
         
            return anchor;
         }
      </script>
   </body>
</html>